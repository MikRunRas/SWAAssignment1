<html>

<head>
    <title>Weather Forecast For You And Me And Everyone Else</title>
    <style>
        td {
            width: 40px;
            height: 40px;
            border: 1px solid black;
        }

        table {
            border: 1px solid black;
            border-spacing: 0;
        }
    </style>
    <script type='module'>
        import view from './view.js'
        import { currentModel, forecastModel } from './model.js'

        const LOG = (msg) => console.log(msg)

        function displayCurrent(theView, temperature, percipitation, wind, cloud) {
            const theModel = currentModel({ temperature, percipitation, wind, cloud })
            const weatherTable = document.getElementById('weather_data');
            //Clear existing rows
            while (weatherTable.firstChild) {
                weatherTable.removeChild(weatherTable.firstChild);
            }
            theView.updateCurrent(theModel)
        }

        function displayForecast(theView, temperature, percipitation, wind, cloud) {
            const theModel = forecastModel({ temperature, percipitation, wind, cloud })
            const forecastTable = document.getElementById('forecast');
            //Clear existing rows
            while (forecastTable.firstChild) {
                forecastTable.removeChild(forecastTable.firstChild);
            }
            theView.updateForecast(theModel)
        }

        //Hardcoded value for Aarhus is not a great solution, but it is our solution.
        window.init = async function (selectedValue = 'Aarhus') {
            // Debugging Purposes
            // LOG('Initialising')

            const theView = view(window)

            try {
                getCurrentWeather(selectedValue, theView)
                getForecast(selectedValue, theView)
            }
            catch (e) {
                LOG(`\tinit.catch: ${e}`)
                theView.displayError(e)
            }
        }

        async function getCurrentWeather(city, theView) {
            // LOG('Fetching LocalHost:8080/data')
            const currentDataResponse = await fetch('http://localhost:8080/data' + '/' + city)


            // LOG('Checking Response')
            if (!currentDataResponse.ok) {
                LOG('Response was not OK')
                throw currentDataResponse.statusText
            }

            // LOG('Retreiving WeatherData')
            const weatherData = await currentDataResponse.json()

            // LOG('Splitting Data into Objects [Object Destructuring]')
            let temp_data, perc_data, wind_data, cloud_data
            [temp_data, perc_data, wind_data, cloud_data] = weatherData
            // LOG(`T: ${temperature.type}\nN: ${percipitation.type}\nW: ${wind_speed.type}\nC: ${cloud_coverage.type}`)

            LOG('Attempt to display data')
            displayCurrent(theView, temp_data, perc_data, wind_data, cloud_data)
        }

        async function getForecast(city, theView) {
            // LOG('Fetching LocalHost:8080/data')
            const forecastResponse = await fetch('http://localhost:8080/forecast' + '/' + city)


            // LOG('Checking Response')
            if (!forecastResponse.ok) {
                LOG('Response was not OK')
                throw forecastResponse.statusText
            }

            // LOG('Retreiving WeatherData')
            const weatherData = await forecastResponse.json()

            // LOG('Splitting Data into Objects [Object Destructuring]')
            let temp_data, perc_data, wind_data, cloud_data
            [temp_data, perc_data, wind_data, cloud_data] = weatherData
            //LOG(`T: ${temperature.type}\nN: ${percipitation.type}\nW: ${wind_speed.type}\nC: ${cloud_coverage.type}`)

            LOG('Attempt to display data')
            displayForecast(theView, temp_data, perc_data, wind_data, cloud_data)
        }

        function selectOption() {
            console.log("Testing")
            let selectedValue = dropdown.options[dropdown.selectedIndex].text
            init(selectedValue)
        }

        window.selectOption = selectOption

        const dropdown = document.getElementById('dropdown')
        dropdown.addEventListener('change', selectOption)

        init()
    </script>
</head>

<body onload="init()">
    <div id='base'>
        <h1>Current Weather</h1>
        <select id="dropdown" onchange="selectOption()">
            <option selected>Aarhus</option>
            <option>Horsens</option>
            <option>Copenhagen</option>
        </select>
        <table id='weather'>
            <thead>
                <tr>
                    <td>Temperature</td>
                    <td>Wind</td>
                    <td>Rain</td>
                </tr>
            </thead>
            <tbody id='weather_data'></tbody>
        </table>
        <p id='error_messages' />
        <h1>Forecast for next 24 hours</h1>
        <table id='forecast'>
            <thead>
                <tr>
                    <td>Temperature</td>
                    <td>Wind</td>
                    <td>Cloud Coverage</td>
                    <td>Rain</td>
                </tr>
            </thead>
        </table>
        <!--<h1>Last 24 hours</h1>
    <table id='last_day_data'>
        <thead>
        <tr>
        <td>Min Temp</td>
        <td>Max Temp</td>
        <td>Total precipitation</td>
        <td>Average windspeed</td>
        </tr>
        </thead>
    </table>-->
    </div>

</body>

</html>